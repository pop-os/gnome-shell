From: =?utf-8?b?Ik1hcmNvIFRyZXZpc2FuIChUcmV2acOxbyki?= <mail@3v1n0.net>
Date: Fri, 25 Feb 2022 01:07:12 +0100
Subject: main: Support loading multiple Yaru theme variants

Yaru can provide multiple variants, we can support using more theme
variants in GNOME shell as it happens on Gtk apps.

So, make StSettings to compute the main theme and the chosen variant,
and we use those to pick the correct .css file.

We don't make difference between dark/light themes here, as we assume
that the shell theme will always be dark or light.

Forwarded: not-needed
---
 js/ui/main.js        | 20 +++++++++++++
 src/st/st-settings.c | 80 ++++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 100 insertions(+)

diff --git a/js/ui/main.js b/js/ui/main.js
index 8add6fc..146b078 100644
--- a/js/ui/main.js
+++ b/js/ui/main.js
@@ -161,6 +161,8 @@ function start() {
     sessionMode.connect('updated', _sessionUpdated);
 
     St.Settings.get().connect('notify::high-contrast', _loadDefaultStylesheet);
+    St.Settings.get().connect('notify::gtk-theme', _loadDefaultStylesheet);
+    St.Settings.get().connect('notify::gtk-theme-variant', _loadDefaultStylesheet);
 
     // Initialize ParentalControlsManager before the UI
     ParentalControlsManager.getDefault();
@@ -398,6 +400,17 @@ function _getStylesheet(name) {
     return null;
 }
 
+function _getYaruStyleSheet(themeVariant) {
+    const baseThemeName = sessionMode.stylesheetName.split(".css").at(0);
+    const stylesheet = _getStylesheet(`${baseThemeName}-${themeVariant.toLowerCase()}.css`);
+
+    // Try to use the dark theme if a dark variant is selected
+    if (!stylesheet && themeVariant.endsWith('-dark'))
+        return _getStylesheet(`${baseThemeName}-dark.css`);
+
+    return stylesheet;
+}
+
 function _getDefaultStylesheet() {
     let stylesheet = null;
     let name = sessionMode.stylesheetName;
@@ -406,6 +419,13 @@ function _getDefaultStylesheet() {
     if (St.Settings.get().high_contrast)
         stylesheet = _getStylesheet(name.replace('.css', '-high-contrast.css'));
 
+    if (stylesheet == null) {
+        const settings = St.Settings.get();
+
+        if (settings.gtk_theme == 'Yaru' && settings.gtk_theme_variant)
+            stylesheet = _getYaruStyleSheet(settings.gtk_theme_variant);
+    }
+
     if (stylesheet == null)
         stylesheet = _getStylesheet(sessionMode.stylesheetName);
 
diff --git a/src/st/st-settings.c b/src/st/st-settings.c
index c7db08b..13f2aac 100644
--- a/src/st/st-settings.c
+++ b/src/st/st-settings.c
@@ -33,6 +33,7 @@
 #define KEY_FONT_NAME             "font-name"
 #define KEY_HIGH_CONTRAST         "high-contrast"
 #define KEY_GTK_ICON_THEME        "icon-theme"
+#define KEY_GTK_THEME             "gtk-theme"
 #define KEY_MAGNIFIER_ACTIVE      "screen-magnifier-enabled"
 #define KEY_DISABLE_SHOW_PASSWORD "disable-show-password"
 
@@ -43,6 +44,8 @@ enum {
   PROP_DRAG_THRESHOLD,
   PROP_FONT_NAME,
   PROP_HIGH_CONTRAST,
+  PROP_GTK_THEME,
+  PROP_GTK_THEME_VARIANT,
   PROP_GTK_ICON_THEME,
   PROP_MAGNIFIER_ACTIVE,
   PROP_SLOW_DOWN_FACTOR,
@@ -64,6 +67,8 @@ struct _StSettings
   gchar *font_name;
   gboolean high_contrast;
   gchar *gtk_icon_theme;
+  gchar *gtk_theme;
+  gchar *gtk_theme_variant;
   int inhibit_animations_count;
   gboolean enable_animations;
   gboolean primary_paste;
@@ -134,6 +139,8 @@ st_settings_finalize (GObject *object)
   g_object_unref (settings->a11y_interface_settings);
   g_object_unref (settings->lockdown_settings);
   g_free (settings->font_name);
+  g_free (settings->gtk_theme);
+  g_free (settings->gtk_theme_variant);
   g_free (settings->gtk_icon_theme);
 
   G_OBJECT_CLASS (st_settings_parent_class)->finalize (object);
@@ -188,6 +195,12 @@ st_settings_get_property (GObject    *object,
       else
         g_value_set_string (value, settings->gtk_icon_theme);
       break;
+    case PROP_GTK_THEME:
+      g_value_set_string (value, settings->gtk_theme);
+      break;
+    case PROP_GTK_THEME_VARIANT:
+      g_value_set_string (value, settings->gtk_theme_variant);
+      break;
     case PROP_MAGNIFIER_ACTIVE:
       g_value_set_boolean (value, settings->magnifier_active);
       break;
@@ -278,6 +291,28 @@ st_settings_class_init (StSettingsClass *klass)
                                                     "",
                                                     ST_PARAM_READABLE);
 
+  /**
+   * StSettings:gtk-theme:
+   *
+   * The current GTK theme
+   */
+  props[PROP_GTK_THEME] = g_param_spec_string ("gtk-theme",
+                                               "GTK Theme",
+                                               "GTK Theme",
+                                               "",
+                                               ST_PARAM_READABLE);
+
+  /**
+   * StSettings:gtk-theme-variant:
+   *
+   * The current GTK theme
+   */
+  props[PROP_GTK_THEME_VARIANT] = g_param_spec_string ("gtk-theme-variant",
+                                                       "GTK Theme Variant",
+                                                       "GTK Theme Variant",
+                                                       "",
+                                                       ST_PARAM_READABLE);
+
   /**
    * StSettings:magnifier-active:
    *
@@ -314,6 +349,45 @@ st_settings_class_init (StSettingsClass *klass)
   g_object_class_install_properties (object_class, N_PROPS, props);
 }
 
+static void
+update_theme_settings (StSettings *settings)
+{
+  g_auto(GStrv) parts = NULL;
+  g_autofree char *theme = NULL;
+  g_autofree char *variant = NULL;
+
+  theme = g_settings_get_string (settings->interface_settings, KEY_GTK_THEME);
+  parts = g_strsplit (theme, "-", 2);
+
+  switch (g_strv_length (parts))
+    {
+    case 2:
+      variant = g_strdup (parts[1]);
+      /* fallthrough */
+    case 1:
+      theme = g_strdup (parts[0]);
+      break;
+    }
+
+  if (g_strcmp0 (settings->gtk_theme, theme) != 0)
+    {
+      g_free (settings->gtk_theme);
+      settings->gtk_theme = g_steal_pointer (&theme);
+
+      g_object_notify_by_pspec (G_OBJECT (settings),
+                                props[PROP_GTK_THEME]);
+    }
+
+  if (g_strcmp0 (settings->gtk_theme_variant, variant) != 0)
+    {
+      g_free (settings->gtk_theme_variant);
+      settings->gtk_theme_variant = g_steal_pointer (&variant);
+
+      g_object_notify_by_pspec (G_OBJECT (settings),
+                                props[PROP_GTK_THEME_VARIANT]);
+    }
+}
+
 static void
 on_interface_settings_changed (GSettings   *g_settings,
                                const gchar *key,
@@ -335,6 +409,10 @@ on_interface_settings_changed (GSettings   *g_settings,
       settings->font_name = g_settings_get_string (g_settings, key);
       g_object_notify_by_pspec (G_OBJECT (settings), props[PROP_FONT_NAME]);
     }
+  else if (g_str_equal (key, KEY_GTK_THEME))
+    {
+      update_theme_settings (settings);
+    }
   else if (g_str_equal (key, KEY_GTK_ICON_THEME))
     {
       g_free (settings->gtk_icon_theme);
@@ -417,6 +495,8 @@ st_settings_init (StSettings *settings)
   g_signal_connect (settings->lockdown_settings, "changed",
                     G_CALLBACK (on_lockdown_settings_changed), settings);
 
+  update_theme_settings (settings);
+
   settings->enable_animations = g_settings_get_boolean (settings->interface_settings,
                                                         KEY_ENABLE_ANIMATIONS);
   settings->primary_paste = g_settings_get_boolean (settings->interface_settings,
